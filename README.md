# PLCalibration
Auto calibration program for photoluminescence spectra

----------------------------------
calibration.py

・Python3のインストールが必要です。

・Mac OSで作成したので、もしWindowsでエラーが出たらごめんなさい。修正するので内容を教えてください。

・各種Pythonライブラリのインストールが必要です。

    Pythonをインストールしたら、コマンドプロンプトから

    pip install numpy
    pip install pandas
    pip install scipy
    pip install sklearn

    を実行してライブラリをインストールしてください。

    pip list

    によってインストール済のライブラリを確認できます。

・使い方

    コマンドプロンプトで、calibration.pyのあるディレクトリまで移動して

    python calibration.py

    とすると実行できます。
    まずキャリブレーションに使うascファイルのパスを聞かれるので入力してEnter。（相対パスでも絶対パスでもいいと思います。）

    次に、キャリブレーションしたいファイルが入ったフォルダのパスを入力してEnter。例えば
    -data
      |- 220318_0001.asc
      |- 220318_0002.asc
            ・・・
    みたいなフォルダを用意し、dataフォルダのパスを入力してください。
    すると、dataフォルダと同じ場所にdata_calibratedフォルダが作成され、
    中にはキャリブレーション済のファイルたちが入っていると思います。


・補足（コードの内容）

    ①pandasでファイルを読み込みDataFrameにします。
    この時、1列目を一度index_colにしてからreset_indexをしています。
    indexを使用してピーク検出やキャリブレーションを行うためです。
    resetじゃなくて、int型にキャストするのでも良いです。コードが短くて済むのでこうしています。
    
    ②scipyのfind_peaksでピーク検出します。
    全ての値の平均値(y.mean())より上にあるピークのみ検出します。（ノイズのピークまで検出しないように）
    ここは改善の余地ありです。
    
    ③検出したピークのうち、ArHgランプの文献値に近いものをピックアップして線形回帰モデルを作成します。
    大小3nmの幅のズレまで許容しています。それ以上ずれたものはピックアップしません。
    文献値はエクセルのあるものをコピペしました。NIST ASDと比較たところ、大体はあってるみたいです。
    indexの0乗、1乗、2乗、3乗を説明変数に、文献値を目的変数に入れてフィッティングさせます。
    ピックアップされたピークが2, 3本しかないなら Linear (1乗まで）
    中心波長付近にあるときは Quadratic (2乗まで)
    全体に分布しているときは Cubic (3乗まで)
    がいいらしいです。今回はCubicにしています。
    
    ④[0, 1, 2, ..., 511]の配列をモデルに入れ、キャリブレーション後の横軸の値を算出します。
    
    ⑤指定されたフォルダ内のascファイルを読み込み、波長の値を④のものと書き換え、新しいフォルダに出力します。
